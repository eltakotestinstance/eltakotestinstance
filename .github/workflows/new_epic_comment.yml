name: Update milestone description

on:
    workflow_dispatch:
        inputs:
            issue_key:
                description: 'Jira issue key'
                required: true
            author:
                description: 'Author'
                required: true
            text:
                description: 'Text'
                required: true

jobs:
    update_description:
        runs-on: ubuntu-latest
        steps:
            - name: Set text as output
              id: set_text
              run: |
                text="${{ github.event.inputs.text }}"
                text="${text//'%'/'%25'}"
                text="${text//$'\n'/'<br>'}"
                text="${text//$'\r'/'<br>'}"
                echo "text=$text" >> $GITHUB_OUTPUT
            - name: Update milestone description
              uses: actions/github-script@v6
              with:
                    github-token: ${{ secrets.PERSONAL_TOKEN }}
                    script: |
                        const issueKey = "${{ github.event.inputs.issue_key }}";
                        const author = "${{ github.event.inputs.author }}";
                        let text = "${{ steps.set_text.outputs.text }}";
                        text = text.replace(/<br>/g, '\n');
                        const timestamp = new Date().toISOString();

                        const milestones = await github.rest.issues.listMilestones({
                            owner: context.repo.owner,
                            repo: context.repo.repo,
                            state: 'open',
                        });

                        for (const milestone of milestones.data) {
                            if (milestone.description.includes(issueKey)) {
                                const newDescription = `${milestone.description}\n---\n### ${author}: \n${text}\n(${timestamp})`;
                                await github.rest.issues.updateMilestone({
                                    owner: context.repo.owner,
                                    repo: context.repo.repo,
                                    milestone_number: milestone.number,
                                    description: newDescription,
                                });
                                break;
                            }
                        }
              